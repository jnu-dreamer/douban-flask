{% extends "base.html" %}
{% block title %}豆瓣电影 - AI 聚类分析{% endblock %}
{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
{% endblock %}
{% block content %}
<div class="mb-4">
    <h3 class="h3 fw-bold text-gray-800">AI 语义聚类分析</h3>
    <p class="text-muted">使用 K-Means 算法根据电影简介的语义相似度进行聚类 (降维至 2D 展示)</p>
</div>

<div class="card shadow mb-4 border-0 rounded-3">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white border-bottom">
        <h6 class="m-0 fw-bold text-primary">电影语义空间分布图</h6>
        <div class="d-flex align-items-center">
            <label class="me-2 small text-muted">聚类数量:</label>
            <select id="clusterCount" class="form-select form-select-sm me-3" style="width: auto;">
                <option value="10">10类 (粗略)</option>
                <option value="12" selected>12类 (标准)</option>
                <option value="15">15类 (精细)</option>
                <option value="20">20类 (极细)</option>
            </select>
            <button class="btn btn-sm btn-primary" onclick="loadChart()">
                <i class="bi bi-arrow-clockwise"></i> 重新计算
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="clusterChart" style="height: 600px;"></div>
        <div class="mt-3 text-muted small text-center">
            * 坐标点越接近，说明两部电影的剧情关键词越相似。此图通过 TF-IDF 特征提取 + PCA 降维生成。
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    var chartDom = document.getElementById('clusterChart');
    var myChart = echarts.init(chartDom);
    var option;

    function loadChart() {
        var k = document.getElementById('clusterCount').value;
        myChart.showLoading();

        fetch(`{{ url_for("clustering_data") }}?k=${k}`)
            .then(response => response.json())
            .then(data => {
                myChart.hideLoading();

                if (data.error) {
                    alert("聚类分析失败: " + data.error);
                    return;
                }

                renderChart(data);
            })
            .catch(error => {
                myChart.hideLoading();
                console.error('Error:', error);
                alert("加载数据失败");
            });
    }

    function renderChart(data) {
        option = {
            title: {
                text: '电影题材聚类',
                subtext: '基于剧情简介 (TF-IDF + K-Means)',
                left: 'center'
            },
            grid: {
                left: '3%',
                right: '7%',
                bottom: '3%',
                containLabel: true
            },
            tooltip: {
                trigger: 'item',
                showDelay: 0,
                formatter: function (params) {
                    return '<div style="font-weight:bold">' + params.value[2] + '</div>'
                        + '坐标: (' + params.value[0] + ', ' + params.value[1] + ')<br/>'
                        + '<small class="text-muted">点击查看详情</small>';
                },
                axisPointer: {
                    show: true,
                    type: 'cross',
                    lineStyle: {
                        type: 'dashed',
                        width: 1
                    }
                }
            },
            legend: {
                data: data.map(cluster => cluster.name),
                left: 'center',
                bottom: 10
            },
            xAxis: [
                {
                    type: 'value',
                    scale: true,
                    axisLabel: {
                        formatter: '{value}'
                    },
                    splitLine: {
                        show: false
                    }
                }
            ],
            yAxis: [
                {
                    type: 'value',
                    scale: true,
                    axisLabel: {
                        formatter: '{value}'
                    },
                    splitLine: {
                        show: false
                    }
                }
            ],
            series: data.map(cluster => ({
                name: cluster.name,
                type: 'scatter',
                symbolSize: 10,
                emphasis: {
                    focus: 'series'
                },
                data: cluster.data
            }))
        };

        myChart.setOption(option, true);

        // Add click event
        myChart.off('click');
        myChart.on('click', function (params) {
            if (params.value && params.value[3]) {
                window.open(params.value[3], '_blank');
            }
        });
    }

    // Initial load
    loadChart();

    window.addEventListener('resize', function () {
        myChart.resize();
    });
</script>
{% endblock %}