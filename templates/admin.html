{% extends "base.html" %}
{% block title %}è±†ç“£ç”µå½± - åå°ç®¡ç†{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">

        <!-- æ•°æ®æºåˆ‡æ¢å™¨ -->
        <div class="card shadow rounded-3 border-0 mb-4">
            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-success"><i class="fas fa-database me-2"></i>æ•°æ®æºç®¡ç†</h5>
                <span class="badge bg-success">å½“å‰è¡¨: {{ current_table }}</span>
            </div>
            <div class="card-body p-4">
                <!-- 1. åˆ‡æ¢è¡¨å• -->
                <!-- 1. åˆ‡æ¢è¡¨å• -->
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label for="tableName" class="form-label fw-bold">1. é€‰æ‹©æ•°æ®è¡¨ (åˆ‡æ¢)</label>
                        <select class="form-select" id="tableName" name="table_name">
                            {% for table in tables %}
                            <option value="{{ table }}" {% if table==current_table %}selected{% endif %}>
                                {{ table }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            å½“å‰ç”Ÿæ•ˆ: <span class="fw-bold text-success" id="currentTableLabel">{{ current_table }}</span>
                            <span class="text-muted ms-2">(åˆ‡æ¢åè‡ªåŠ¨é‡å»º AI ç´¢å¼•)</span>
                        </div>
                    </div>
                    <div class="col-md-4 align-self-center">
                        <div class="d-grid">
                            <button type="button" id="btnSwitch" class="btn btn-primary" onclick="switchAndRebuild()">
                                <i class="fas fa-sync-alt me-2"></i> ç¡®è®¤åˆ‡æ¢
                            </button>
                        </div>
                    </div>

                    <!-- çŠ¶æ€æ˜¾ç¤º -->
                    <div class="col-12" id="switchStatusArea" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center mb-0">
                            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                            <div id="switchStatusText">æ­£åœ¨åˆ‡æ¢æ•°æ®è¡¨å¹¶é‡å»ºç´¢å¼•ï¼Œè¯·ç¨å€™...</div>
                        </div>
                    </div>
                </div>

                <hr class="text-muted opacity-25 my-4">

                <!-- 2. é‡å‘½åè¡¨å• -->
                <form action="{{ url_for('rename_table') }}" method="post" class="row g-3 align-items-center">
                    <input type="hidden" name="old_name" value="{{ current_table }}">
                    <div class="col-md-8">
                        <label for="newName" class="form-label fw-bold">
                            <i class="fas fa-edit me-1"></i> 2. é‡å‘½åå½“å‰è¡¨ ({{ current_table }})
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-white">æ–°åç§°</span>
                            <input type="text" class="form-control" id="newName" name="new_name"
                                placeholder="ä¾‹å¦‚: movies_å¤‡ä»½, movies_2024" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-warning"
                                onclick="return confirm('âš ï¸ è­¦å‘Šï¼š\nç¡®è®¤é‡å‘½åå—ï¼Ÿ\n\né‡å‘½ååï¼ŒåŸè¡¨å°†ç§»åŠ¨åˆ°æ–°åç§°ã€‚');">
                                é‡å‘½å
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow rounded-3 border-0 mb-4">
            <div class="card-header bg-white py-3 border-bottom">
                <h5 class="m-0 fw-bold text-primary">çˆ¬è™«æ§åˆ¶å° (Crawler Console)</h5>
            </div>
            <div class="card-body p-4">

                <div class="alert alert-light border shadow-sm mb-4">
                    <h6 class="alert-heading fw-bold"><i class="fas fa-info-circle text-info"></i> æ“ä½œè¯´æ˜</h6>
                    <ul class="mb-0 small text-muted ps-3">
                        <li>çˆ¬å–è¿‡ç¨‹å¯èƒ½éœ€è¦ 30ç§’ - 3åˆ†é’Ÿï¼Œè§†é¡µæ•°è€Œå®šã€‚</li>
                        <li>å»ºè®®æ¯æ¬¡çˆ¬å–é—´éš” 1 åˆ†é’Ÿä»¥ä¸Šï¼Œé˜²æ­¢ IP è¢«å°ç¦ã€‚</li>
                    </ul>
                </div>

                <form id="crawlForm">
                    <!-- 1. æ¨¡å¼é€‰æ‹© -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">æ¨¡å¼é€‰æ‹©</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="crawl_type" id="type_top250" value="top250"
                                checked>
                            <label class="btn btn-outline-primary" for="type_top250">Top 250 æ¦œå•</label>

                            <input type="radio" class="btn-check" name="crawl_type" id="type_tag" value="tag">
                            <label class="btn btn-outline-primary" for="type_tag">æŒ‰å…³é”®è¯æœç´¢</label>
                        </div>
                    </div>

                    <!-- 2. å…³é”®è¯è¾“å…¥ (é»˜è®¤éšè—) -->
                    <div id="tagInputGroup" class="mb-4 bg-light p-3 rounded" style="display: none;">
                        <label for="tagname" class="form-label fw-bold">è¯·è¾“å…¥æœç´¢å…³é”®è¯</label>
                        <input type="text" class="form-control" id="tagname" name="tag"
                            placeholder="ä¾‹å¦‚ï¼šå–œå‰§, ç§‘å¹», 2023, æˆé¾™...">
                        <div class="form-text">æ”¯æŒè¾“å…¥ä»»æ„å…³é”®è¯ã€‚</div>
                    </div>

                    <!-- 3. æ’åºæ–¹å¼ (é»˜è®¤éšè—) -->
                    <div id="sortInputGroup" class="mb-4 bg-light p-3 rounded" style="display: none;">
                        <label for="sort" class="form-label fw-bold">æ’åºæ–¹å¼</label>
                        <select class="form-select" id="sort" name="sort">
                            <option value="recommend" selected>æŒ‰çƒ­åº¦æ¨è (Recommend)</option>
                            <option value="rank">æŒ‰è¯„ä»·æ’åº (High Score)</option>
                            <option value="time">æŒ‰æ—¶é—´æ’åº (Release Date)</option>
                            <option value="recent">è¿‘æœŸçƒ­é—¨ (Trending)</option>
                        </select>
                        <div class="form-text">"æ¨è"æ•°é‡è¾ƒå°‘ä½†ç»å…¸ï¼Œ"è¯„ä»·"æ•°é‡å……è¶³ã€‚</div>
                    </div>

                    <!-- 4. é€‰é¡¹é…ç½® (ç¬¬äºŒè¡Œ) -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div id="pagesInputGroup">
                                <label for="pages" class="form-label fw-bold">çˆ¬å–é¡µæ•° (Top 250)</label>
                                <select class="form-select" id="pages" name="pages">
                                    <option value="1">1 é¡µ (çº¦25éƒ¨)</option>
                                    <option value="3">3 é¡µ (çº¦75éƒ¨)</option>
                                    <option value="5">5 é¡µ (çº¦125éƒ¨)</option>
                                    <option value="10" selected>10 é¡µ (å®Œæ•´æ¦œå• / çº¦250éƒ¨)</option>
                                </select>
                            </div>
                            <div id="limitInputGroup" style="display: none;">
                                <label for="limit" class="form-label fw-bold">çˆ¬å–æ•°é‡ (Tag æ¨¡å¼)</label>
                                <input type="number" class="form-control" id="limit" name="limit" value="50" min="1"
                                    max="500">
                                <div class="form-text">ä¸€æ¬¡æ€§è¯·æ±‚çš„æ•°é‡ (å»ºè®® 20-200)</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="target_table" class="form-label fw-bold">ç›®æ ‡æ•°æ®è¡¨ (å¯é€‰)</label>
                            <input type="text" class="form-control" id="target_table" name="target_table"
                                placeholder="é»˜è®¤ä¸º movies">
                            <div class="form-text">æŒ‡å®šè¡¨åå¯å°†å¤šæ‰¹æ•°æ®å­˜å…¥åŒä¸€å¼ è¡¨ã€‚</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">å­˜å‚¨ç­–ç•¥</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="no_clear" name="no_clear">
                                <label class="form-check-label" for="no_clear">
                                    è¿½åŠ æ¨¡å¼ (Append)
                                </label>
                            </div>
                            <div class="form-text small">å‹¾é€‰åå°†ä¸æ¸…ç©ºæ—§æ•°æ®ï¼Œç›´æ¥è¿½åŠ ã€‚</div>
                        </div>
                    </div>

                    <!-- 4. æäº¤æŒ‰é’® -->
                    <div class="d-grid">
                        <button type="submit" id="btnSubmit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play me-2"></i> å¼€å§‹çˆ¬å–
                        </button>
                    </div>
                </form>

                <!-- çŠ¶æ€åé¦ˆåŒº -->
                <div id="statusArea" class="mt-4" style="display: none;">
                    <div class="alert alert-primary d-flex align-items-center border-0 shadow-sm" role="alert">
                        <div class="spinner-border text-primary me-3" role="status" id="loadingSpinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1" id="statusTitle">æ­£åœ¨åˆå§‹åŒ–...</h6>
                            <p class="mb-0 small" id="statusText">è¯·ä¿æŒé¡µé¢å¼€å¯...</p>
                        </div>
                    </div>
                    <!-- è¿›åº¦æ¡ (å¯æ¥æ”¶åŠ¨æ€æ›´æ–°) -->
                    <div class="progress mt-2" style="height: 5px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 3. æ—¥å¿—ç›‘æ§ (æŠ˜å ç‰ˆ) -->
        <button class="btn btn-outline-secondary w-100 mb-3 shadow-sm" type="button" data-bs-toggle="collapse"
            data-bs-target="#logCollapse" aria-expanded="false" aria-controls="logCollapse">
            <i class="fas fa-terminal me-2"></i> æ˜¾ç¤º / éšè— ç³»ç»Ÿæ—¥å¿—ç›‘æ§
        </button>
        <div class="collapse" id="logCollapse">
            <div class="card shadow rounded-3 border-0 mb-4">
                <div class="card-header bg-dark text-white py-2">
                    <small class="fw-bold">Console Output</small>
                </div>
                <div class="card-body bg-dark text-white font-monospace p-0">
                    <div id="logViewer" class="p-3"
                        style="height: 300px; overflow-y: auto; font-size: 0.85rem; line-height: 1.4;">
                        <div class="text-white-50">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
                    </div>
                    <div class="p-2 bg-secondary bg-opacity-25 text-end">
                        <small class="text-white-50 me-3">æ¯ 2 ç§’è‡ªåŠ¨åˆ·æ–°</small>
                        <button class="btn btn-sm btn-outline-light" onclick="loadLogs()">ç«‹å³åˆ·æ–°</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

<!-- Rename Modal -->


{% block scripts %}
{{ super() }}
<script>
    // æ ‡ç­¾è¾“å…¥æ¡†çš„ UI åˆ‡æ¢
    // æ ‡ç­¾è¾“å…¥æ¡†çš„ UI åˆ‡æ¢
    document.querySelectorAll('input[name="crawl_type"]').forEach((elem) => {
        elem.addEventListener("change", function (event) {
            const tagGroup = document.getElementById('tagInputGroup');
            const limitGroup = document.getElementById('limitInputGroup');
            const pagesGroup = document.getElementById('pagesInputGroup');

            if (event.target.value === "tag") {
                tagGroup.style.display = "block";
                limitGroup.style.display = "block";
                document.getElementById('sortInputGroup').style.display = "block";
                pagesGroup.style.display = "none";
            } else {
                tagGroup.style.display = "none";
                limitGroup.style.display = "none";
                document.getElementById('sortInputGroup').style.display = "none";
                pagesGroup.style.display = "block";
            }
        });
    });

    // è½®è¯¢é€»è¾‘
    let pollInterval;

    function startPolling() {
        pollInterval = setInterval(() => {
            fetch('/api/progress')
                .then(r => r.json())
                .then(data => {
                    const statusText = document.getElementById('statusText');
                    const statusTitle = document.getElementById('statusTitle');
                    const progressBar = document.getElementById('progressBar');

                    statusText.innerText = data.message;

                    if (data.total > 0) {
                        const pct = Math.round((data.current / data.total) * 100);
                        progressBar.style.width = pct + "%";
                    }

                    if (data.status === 'finished') {
                        clearInterval(pollInterval);
                        statusTitle.innerText = "å®Œæˆï¼";
                        statusTitle.className = "fw-bold mb-1 text-success";
                        document.getElementById('loadingSpinner').style.display = "none";
                        setTimeout(() => {
                            alert("çˆ¬å–æˆåŠŸï¼è¯·åœ¨ä¸Šæ–¹ä¸‹æ‹‰èœå•ä¸­åˆ‡æ¢åˆ°æ–°æ•°æ®è¡¨æŸ¥çœ‹ã€‚");
                            window.location.reload();
                        }, 1000);
                    } else if (data.status === 'error') {
                        clearInterval(pollInterval);
                        statusTitle.innerText = "å‡ºé”™";
                        statusTitle.className = "fw-bold mb-1 text-danger";
                        document.getElementById('loadingSpinner').style.display = "none";
                        document.getElementById('btnSubmit').disabled = false;
                    }
                });
        }, 1000);
    }

    // è¡¨å•æäº¤
    document.getElementById('crawlForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => data[key] = value);
        data['no_clear'] = document.getElementById('no_clear').checked;

        if (data.crawl_type === 'tag' && !data.tag) {
            alert("è¯·è¾“å…¥ç±»å‹åç§°ï¼");
            return;
        }

        // UI é‡ç½®
        const btn = document.getElementById('btnSubmit');
        const statusArea = document.getElementById('statusArea');

        btn.disabled = true;
        statusArea.style.display = 'block';
        document.getElementById('progressBar').style.width = "0%";
        document.getElementById('statusTitle').innerText = "æ­£åœ¨å¯åŠ¨...";
        document.getElementById('statusTitle').className = "fw-bold mb-1 text-primary";
        document.getElementById('loadingSpinner').style.display = "block";

        fetch('/api/crawl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(res => {
                if (res.status === 'success') {
                    startPolling();
                } else {
                    alert("å¯åŠ¨å¤±è´¥: " + res.message);
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("è¯·æ±‚å¤±è´¥");
                btn.disabled = false;
            });
    });

    // --- æ–°ç‰ˆ Log ç›‘æ§é€»è¾‘ ---
    function loadLogs() {
        const viewer = document.getElementById('logViewer');
        const statusArea = document.getElementById('switchStatusArea');

        fetch('/api/logs')
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    viewer.innerHTML = `<div class="text-danger">æ—¥å¿—è·å–å¤±è´¥: ${data.error}</div>`;
                    return;
                }
                if (data.lines && data.lines.length > 0) {
                    // 1. æ¸²æŸ“æ—¥å¿—
                    const html = data.lines.map(line => {
                        let colorClass = "text-white";
                        if (line.includes("[ERROR]")) colorClass = "text-danger fw-bold";
                        else if (line.includes("[WARNING]")) colorClass = "text-warning";
                        else if (line.includes("[INFO]")) colorClass = "text-info";
                        else if (line.includes("[DEBUG]")) colorClass = "text-secondary";
                        return `<div class="${colorClass}" style="white-space: pre-wrap;">${line}</div>`;
                    }).join("");
                    viewer.innerHTML = html;
                    viewer.scrollTop = viewer.scrollHeight;

                    // 2. æ£€æµ‹ä»»åŠ¡å®Œæˆä¸” UI å¤„äºç­‰å¾…çŠ¶æ€
                    const lastLines = data.lines.slice(-5).join("\n");
                    if (statusArea.style.display !== 'none' && lastLines.includes("Background vector rebuild finished successfully")) {
                        const statusText = document.getElementById('switchStatusText');
                        statusText.innerText = "âœ… é‡å»ºå®Œæˆï¼å³å°†åˆ·æ–°é¡µé¢ä»¥åŠ è½½æ–°æ•°æ®...";
                        statusText.className = "text-success fw-bold";
                        setTimeout(() => window.location.reload(), 2000);
                    }
                } else {
                    viewer.innerHTML = '<div class="text-secondary">æš‚æ— æ—¥å¿—å†…å®¹</div>';
                }
            })
            .catch(e => console.error("Log fetch error:", e));
    }

    // æ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡æ—¥å¿—
    setInterval(loadLogs, 2000);
    loadLogs(); // åˆå§‹åŒ–åŠ è½½

    // --- æ ¸å¿ƒé€»è¾‘: åˆ‡æ¢è¡¨å¹¶é‡å»ºç´¢å¼• ---
    function switchAndRebuild() {
        const tableSelect = document.getElementById('tableName');
        const tableName = tableSelect.value;
        const btn = document.getElementById('btnSwitch');
        const statusArea = document.getElementById('switchStatusArea');
        const statusText = document.getElementById('switchStatusText');
        const currentLabel = document.getElementById('currentTableLabel');

        if (!confirm(`âš ï¸ é«˜èƒ½è­¦å‘Šï¼š\n\nç¡®å®šè¦åˆ‡æ¢åˆ°æ•°æ®è¡¨ [${tableName}] å—ï¼Ÿ\n\nç³»ç»Ÿå°†è‡ªåŠ¨æ‰§è¡Œï¼š\n1. åˆ‡æ¢æ•°æ®æº\n2. å¼ºåˆ¶é‡å»º AI å‘é‡ç´¢å¼• (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)\n\næœŸé—´è¯·å‹¿å…³é—­é¡µé¢ï¼`)) {
            return;
        }

        // UI é”å®š
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>å¤„ç†ä¸­...';
        statusArea.style.display = 'block';
        statusText.innerText = `æ­£åœ¨åˆ‡æ¢è‡³ ${tableName} å¹¶é‡å»ºç´¢å¼•ï¼Œè¯·è€å¿ƒç­‰å¾…...`;
        statusText.className = "alert-info";

        // è°ƒç”¨é‡å»ºæ¥å£ (ä¼šè‡ªåŠ¨åˆ‡æ¢è¡¨)
        fetch('/api/rag/rebuild', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_name: tableName })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    statusText.innerText = "ğŸš€ åå°ä»»åŠ¡å·²å¯åŠ¨ï¼æ•°æ®æºå·²åˆ‡æ¢ï¼ŒAI ç´¢å¼•æ­£åœ¨é‡å»ºä¸­...\nè¯·å…³æ³¨ä¸‹æ–¹ã€Œç³»ç»Ÿæ—¥å¿—ã€æŸ¥çœ‹è¿›åº¦ã€‚";
                    statusText.className = "text-warning fw-bold";
                    currentLabel.innerText = tableName;

                    // 3ç§’åæ¢å¤æŒ‰é’®ï¼Œä½†ä¸åˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i> åˆ‡æ¢å¹¶é‡ç½® RAG';
                    }, 3000);
                } else {
                    statusText.innerText = "âŒ å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯");
                    statusText.className = "text-danger fw-bold";
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i> åˆ‡æ¢å¹¶é‡ç½® RAG';
                }
            })
            .catch(err => {
                console.error(err);
                statusText.innerText = "âŒ è¯·æ±‚é”™è¯¯: " + err;
                statusText.className = "text-danger fw-bold";
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i> åˆ‡æ¢å¹¶é‡ç½® RAG';
            });
    }

</script>
{% endblock %}